---
title: "AD pathway sensitivity analysis"
author: "An Ebner"
date: "August 4, 2015"
output: pdf_document
---

Sensitivity analysis is the study of how the variability in the output of a mathematical model can be apportioned to different sources of uncertainty in its inputs.  This helps us gain an increased understanding of the relationships between input and output variables in the model.

In this case we are interested in the sensitivity of GHG emissions (the output) to the input parameters for anaerobic digestion: VS: volatile solids, TS: total solids, Bo: Bloated output, and TKN: Total Krud Negated

we use the package 'pse' (stands for Parameter Space Exploration) to run a Latin Hypercube Sampling of the parameter space and then to pull significant metrics from the output matrix.

```{r,echo=FALSE,error=FALSE,warning=FALSE,message=FALSE}
library(pse)
```

```{r}

# treatmentClasses.R and treatmentAnaerobicDigestion.R implement the anaerobic digestion pathway
source("treatmentClasses.R") 
source("treatmentAnaerobicDigestion.R") 
source("treatmentLandApplication.R")
library(pse)
# First create a global factors object to store all global parameters we won't study
g1 <- GlobalFactors()

# the Model uses our AD simulation.
oneRun <- function (TS,VS,Bo,TKN) {
    f1 <- Feedstock(type="Sensitivity", TS=TS, VS=VS, Bo=Bo, TKN=TKN)
    res <- AnaerobicDigestionTreatmentPathway(f1, g1, debug = F)
    return (res[[1]]) # first element returned as simple number
}
modelRun <- function (my.data) {
    return(mapply(oneRun, my.data[,1], my.data[,2], my.data[,3], my.data[,4]))
}
```

  The factors we study are "TS", "VS", "Bo", and "TKN".
  Ranges for these parameters are chosen from limits known for the range of feedstocks that may be sent to anaerobic digestion.  We don't know the probability distribution of these parameters, so we choose a uniform distribution to generate random samples from.
  
```{r}
factors <- c("TS", "VS", "Bo", "TKN")
q <- c("qunif", "qunif", "qunif","qunif")

#NOTE: These ranges MIGHT NOT BE CORRECT
q.arg<- list(list(min=7, max=92), list(min=0.5,max=1), list(min=200,max=900),list(min=500,max=5600))
```

The pse packages will create a LHS cube to sample the parameter space.  Latin hypercube sampling (LHS) is a statistical method for generating a sample of plausible collections of parameter values from a multidimensional distribution. The sampling method is often used to construct computer experiments.

```{r,cache=TRUE}
# create 1000 LHS samples
myLHS <- LHS(modelRun, factors, 1000, q, q.arg, nboot=50)

```

Output of the LHS model comprise: 
The ecdf, short for empirical cumulative distribution function, may be used to
illustrate the distribution of the model results, in our case, the range of GHG Emissions.  Note that the entire range is negative, from about -800 to 0, meaning, AD in all cases sequesters carbon.

I don't know what the units of output are.

```{r}
plotecdf(myLHS)
```

A scatter plot of output GHG vs. each of the input parameters shows the general trends in how each parameter affects the output values.  It appears that Emissions output grows more negative as TS, Bo, and VS increase.  There appears to be little relationship between TKN and output emissions.
```{r}
plotscatter(myLHS)
```

Another way to show this relationship is by plotting the the partial (rank) correlation coefficient (pcc or prcc) which measures how strong are the linear associations between the result and each input parameter, after removing the linear effect of the other parameters.
The confidence intervals shown in this plot were generated by bootstrapping.  PRCC confirms the observation made in the scatter plots, in that TS, VS, and Bo are negatively correlated with Emissions, while TKN is relatively uncorrelated.

```{r}
plotprcc(myLHS)
```


